<!-- Wrapper principal -->
<ng-container *ngIf="{ state: state$ | async, steps: steps$ | async, connected: isConnected$ | async } as vm">

<!-- Container wrapper avec layout sidebar + main -->
<div class="character-creation-wrapper">

  <!-- Sidebar gauche - Preview du personnage -->
  <aside class="character-sidebar">
    <!-- Panel de preview visuel -->
    <div class="character-preview-panel">
      <div class="preview-avatar">
        <span class="avatar-placeholder">{{ getAvatarEmoji(vm.state!.characterData) }}</span>
      </div>
      <div class="preview-decorations">
        <span class="deco-star">‚ú¶</span>
        <span class="deco-star">‚ú¶</span>
      </div>
    </div>

    <!-- Panel d'informations -->
    <div class="character-info-panel">
      <h3 class="character-name">{{ vm.state!.characterData.nom || 'H√©ros sans nom' }}</h3>
      <p class="character-class">{{ vm.state!.characterData.job_initial || 'Classe non d√©finie' }}</p>
      <div class="character-gender" *ngIf="vm.state!.characterData.apparence?.sexe">
        <span class="gender-icon">{{ vm.state!.characterData.apparence?.sexe === 'masculin' ? 'M' : 'F' }}</span>
        <span class="gender-text">{{ vm.state!.characterData.apparence?.sexe === 'masculin' ? 'Masculin' : 'F√©minin' }}</span>
      </div>
    </div>

    <!-- Panel de statistiques -->
    <div class="character-stats-panel">
      <h4 class="stats-title">Attributs de base</h4>
      <div class="stat-row">
        <span class="stat-label">Classe</span>
        <span class="stat-value">{{ vm.state!.characterData.job_initial || '-' }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Taille</span>
        <span class="stat-value">{{ vm.state!.characterData.apparence?.taille || '-' }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Cheveux</span>
        <span class="stat-value">{{ vm.state!.characterData.apparence?.style_cheveux || '-' }}</span>
      </div>
      <div class="stat-row" *ngIf="vm.state!.characterData.apparence?.style_barbe">
        <span class="stat-label">Barbe</span>
        <span class="stat-value">{{ vm.state!.characterData.apparence?.style_barbe }}</span>
      </div>
    </div>

    <!-- Indicateur de connexion -->
    <div class="connection-indicator" [class.connected]="vm.connected">
      <span class="status-dot"></span>
      <span class="status-text">{{ vm.connected ? 'Connect√©' : 'Hors ligne' }}</span>
    </div>
  </aside>

  <!-- Contenu principal -->
  <div class="character-main-content">
    
    <!-- Header avec progression -->
    <header class="creation-progress-header">
      <div class="progress-steps">
        <div *ngFor="let step of vm.steps; trackBy: trackByStepId" 
             class="progress-step"
             [class.active]="step.id === vm.state!.currentStep"
             [class.completed]="step.isValid"
             [class.visited]="step.isVisited"
             (click)="goToStep(step.id)">
          <div class="step-circle">
            <span *ngIf="!step.isValid">{{ step.id }}</span>
            <span *ngIf="step.isValid">‚úì</span>
          </div>
          <span class="step-label">{{ step.name }}</span>
        </div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" [style.width.%]="getProgress(vm.state!.currentStep)"></div>
      </div>
    </header>

    <!-- Zone de contenu scrollable -->
    <div class="creation-content-area" *ngIf="!vm.state!.isLoading">
      
      <!-- Affichage d'erreur -->
      <div class="error-banner" *ngIf="vm.state!.error">
        <span class="error-icon">!</span>
        <span class="error-message">{{ vm.state!.error }}</span>
        <button class="error-close" (click)="creationService.setError(null)">√ó</button>
      </div>

      <!-- Container des √©tapes avec animation -->
      <div class="step-container" [@fadeSlideIn]>
        
        <!-- √âtape 1: Nom -->
        <app-name-step 
          *ngIf="vm.state!.currentStep === 1"
          [characterData]="vm.state!.characterData">
        </app-name-step>

        <!-- √âtape 2: Sexe -->
        <app-gender-step 
          *ngIf="vm.state!.currentStep === 2"
          [characterData]="vm.state!.characterData"
          [customizationOptions]="vm.state!.customizationOptions">
        </app-gender-step>

        <!-- √âtape 3: Apparence -->
        <app-appearance-step 
          *ngIf="vm.state!.currentStep === 3"
          [characterData]="vm.state!.characterData"
          [customizationOptions]="vm.state!.customizationOptions">
        </app-appearance-step>

        <!-- √âtape 4: Classe -->
        <app-class-step 
          *ngIf="vm.state!.currentStep === 4"
          [characterData]="vm.state!.characterData">
        </app-class-step>

        <!-- √âtape 5: R√©sum√© et validation -->
        <div *ngIf="vm.state!.currentStep === 5" class="final-step-container">
          
          <!-- Bouton Commencer en haut -->
          <div class="hero-action">
            <div class="character-final-preview">
              <h2 class="hero-title">
                <span class="hero-icon">üè∞</span>
                {{ vm.state!.characterData.nom }}
                <span class="hero-class">{{ vm.state!.characterData.job_initial || 'Aventurier' }}</span>
              </h2>
            </div>
            <button 
              class="commence-button"
              (click)="createCharacterAndStartGame()"
              [disabled]="vm.state!.isLoading || !canGoNext()">
              <span class="commence-icon">‚ú®</span>
              <span class="commence-text">Commencer l'Aventure</span>
              <span class="commence-subtitle">Que l'√©pop√©e commence !</span>
            </button>
          </div>

          <!-- Contenu du r√©sum√© -->
          <app-summary-step 
            [characterData]="vm.state!.characterData"
            [customizationOptions]="vm.state!.customizationOptions">
          </app-summary-step>
        </div>
      </div>
    </div>

    <!-- Overlay de chargement -->
    <div class="loading-overlay" *ngIf="vm.state!.isLoading">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Chargement...</p>
      </div>
    </div>
  </div>
</div>

<!-- Navigation globale (s√©par√©e du conteneur principal) -->
<nav class="creation-navbar" *ngIf="!vm.state!.isLoading">
  <div class="navbar-content">
    
    <!-- Section gauche -->
    <div class="navbar-left">
      <button 
        class="nav-btn secondary"
        (click)="vm.state!.currentStep === 1 ? cancelCreation() : previousStep()"
        [disabled]="vm.state!.isLoading">
        <span class="btn-icon">{{ vm.state!.currentStep === 1 ? 'üè†' : '‚Üê' }}</span>
        <span class="btn-text">{{ vm.state!.currentStep === 1 ? 'Menu' : 'Pr√©c√©dent' }}</span>
      </button>
    </div>
    
    <!-- Section centrale -->
    <div class="navbar-center">
      <button 
        *ngIf="vm.state!.currentStep > 1"
        class="nav-btn ghost"
        (click)="restartCreation()"
        [disabled]="vm.state!.isLoading">
        <span class="btn-icon">üîÑ</span>
        <span class="btn-text">Recommencer</span>
      </button>
      <span class="step-indicator">√âtape {{ vm.state!.currentStep }} / 5</span>
    </div>
    
    <!-- Section droite -->
    <div class="navbar-right">
      <button 
        class="nav-btn"
        [class.primary]="vm.state!.currentStep < 5"
        [class.success]="vm.state!.currentStep === 5"
        [disabled]="!canGoNext() && vm.state!.currentStep < 5"
        (click)="vm.state!.currentStep === 5 ? createCharacterAndStartGame() : nextStep()">
        <span class="btn-text">{{ vm.state!.currentStep === 5 ? 'Cr√©er & Jouer' : 'Suivant' }}</span>
        <span class="btn-icon">{{ vm.state!.currentStep === 5 ? 'Jouer' : '‚Üí' }}</span>
      </button>
    </div>
  </div>
</nav>

</ng-container>

<!-- Message de chargement initial -->
<div class="initial-loading" *ngIf="!(state$ | async)">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <h2>Initialisation d'Aether Game</h2>
    <p>Chargement du syst√®me de cr√©ation de personnage...</p>
  </div>
</div>