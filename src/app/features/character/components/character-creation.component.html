<!-- Wrapper principal -->
<ng-container *ngIf="{ state: state$ | async, steps: steps$ | async, connected: isConnected$ | async } as vm">

<!-- Container principal de crÃ©ation -->
<div class="character-creation-container">
  
  <!-- En-tÃªte avec progression -->
  <div class="creation-header">
    <div class="header-top">
      <h1 class="creation-title">
        <span class="icon">âš”ï¸</span>
        {{ getCurrentStepTitle(vm.steps!, vm.state!.currentStep) }}
      </h1>
      
      <!-- Indicateur de connexion -->
      <div class="connection-status" [class.connected]="vm.connected">
        <span class="status-icon">{{ vm.connected ? 'ğŸŸ¢' : 'ğŸ”´' }}</span>
        <span class="status-text">{{ vm.connected ? 'ConnectÃ© Ã  Aether' : 'Hors ligne' }}</span>
      </div>
    </div>
    
    <!-- Barre de progression -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgress(vm.state!.currentStep)"></div>
      </div>
      <p class="step-indicator">Ã‰tape {{ vm.state!.currentStep }} sur 5</p>
    </div>
    
    <!-- Navigation par Ã©tapes (stepper) -->
    <div class="step-navigation">
      <div *ngFor="let step of vm.steps; trackBy: trackByStepId" 
           class="step-nav-item"
           [class.active]="step.id === vm.state!.currentStep"
           [class.completed]="step.isValid"
           [class.visited]="step.isVisited"
           (click)="goToStep(step.id)">
        <div class="step-number">{{ step.id }}</div>
        <span class="step-name">{{ step.name }}</span>
      </div>
    </div>
  </div>

  <!-- Overlay de chargement -->
  <div class="loading-overlay" *ngIf="vm.state!.isLoading">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Chargement...</p>
    </div>
  </div>

  <!-- Affichage d'erreur -->
  <div class="error-banner" *ngIf="vm.state!.error">
    <span class="error-icon">âš ï¸</span>
    <span class="error-message">{{ vm.state!.error }}</span>
    <button class="error-close" (click)="creationService.setError(null)">Ã—</button>
  </div>

  <!-- Contenu des Ã©tapes -->
  <div class="creation-content" *ngIf="!vm.state!.isLoading">
    
    <!-- Ã‰tape 1: Nom -->
    <app-name-step 
      *ngIf="vm.state!.currentStep === 1"
      [characterData]="vm.state!.characterData">
    </app-name-step>

    <!-- Ã‰tape 2: Sexe -->
    <app-gender-step 
      *ngIf="vm.state!.currentStep === 2"
      [characterData]="vm.state!.characterData"
      [customizationOptions]="vm.state!.customizationOptions">
    </app-gender-step>

    <!-- Ã‰tape 3: Apparence -->
    <app-appearance-step 
      *ngIf="vm.state!.currentStep === 3"
      [characterData]="vm.state!.characterData"
      [customizationOptions]="vm.state!.customizationOptions">
    </app-appearance-step>

    <!-- Ã‰tape 4: Classe -->
    <app-class-step 
      *ngIf="vm.state!.currentStep === 4"
      [characterData]="vm.state!.characterData">
    </app-class-step>

    <!-- Ã‰tape 5: RÃ©sumÃ© et validation -->
    <div *ngIf="vm.state!.currentStep === 5" class="final-step-container">
      
      <!-- Bouton Commencer en haut -->
      <div class="hero-action">
        <div class="character-final-preview">
          <h2 class="hero-title">
            <span class="hero-icon">ğŸ°</span>
            {{ vm.state!.characterData.nom }}
            <span class="hero-class">{{ vm.state!.characterData.job_initial || 'Aventurier' }}</span>
          </h2>
        </div>
        <button 
          class="commence-button"
          (click)="createCharacterAndStartGame()"
          [disabled]="vm.state!.isLoading || !canGoNext()">
          <span class="commence-icon">âœ¨</span>
          <span class="commence-text">Commencer l'Aventure</span>
          <span class="commence-subtitle">Que l'Ã©popÃ©e commence !</span>
        </button>
      </div>

      <!-- Contenu du rÃ©sumÃ© -->
      <app-summary-step 
        [characterData]="vm.state!.characterData"
        [customizationOptions]="vm.state!.customizationOptions">
      </app-summary-step>
    </div>
  </div>
  
  <!-- Debug info (seulement en dev) -->
  <div class="debug-info" *ngIf="false">
    <details>
      <summary>Debug Info</summary>
      <pre>{{ vm.state | json }}</pre>
    </details>
  </div>
</div>

<!-- Navigation globale (en dehors du conteneur scrollable) -->
<div class="bottom-navigation" *ngIf="!vm.state!.isLoading">
  
  <!-- Bouton gauche -->
  <button 
    class="nav-button secondary"
    (click)="vm.state!.currentStep === 1 ? cancelCreation() : previousStep()"
    [disabled]="vm.state!.isLoading">
    <span class="button-icon">{{ vm.state!.currentStep === 1 ? 'ğŸ ' : 'â†' }}</span>
    <span class="button-text">{{ vm.state!.currentStep === 1 ? 'Menu Principal' : 'PrÃ©cÃ©dent' }}</span>
  </button>
  
  <!-- Informations centrales -->
  <div class="nav-center">
    <!-- Bouton recommencer (visible aprÃ¨s l'Ã©tape 1) -->
    <button 
      *ngIf="vm.state!.currentStep > 1"
      class="nav-button tertiary"
      (click)="restartCreation()"
      [disabled]="vm.state!.isLoading">
      <span class="button-icon">ğŸ”„</span>
      <span class="button-text">Recommencer</span>
    </button>
  </div>
  
  <!-- Bouton droit -->
  <button 
    class="nav-button primary"
    [disabled]="!canGoNext() && vm.state!.currentStep < 5"
    [class.create-button]="vm.state!.currentStep === 5"
    (click)="vm.state!.currentStep === 5 ? createCharacterAndStartGame() : nextStep()">
    <span class="button-icon">{{ vm.state!.currentStep === 5 ? 'ğŸ®' : 'â†’' }}</span>
    <span class="button-text">{{ vm.state!.currentStep === 5 ? 'CrÃ©er & Jouer !' : 'Suivant' }}</span>
  </button>
</div>

</ng-container>

<!-- Message de chargement initial -->
<div class="initial-loading" *ngIf="!(state$ | async)">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <h2>Initialisation d'Aether Game</h2>
    <p>Chargement du systÃ¨me de crÃ©ation de personnage...</p>
  </div>
</div>